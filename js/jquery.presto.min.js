/*
 * jQuery Presto plugin v1.0.0.alpha
 * http://matiasgagliano.github.com/presto/
 *
 * Copyright 2014, Mat√≠as Gagliano.
 * Dual licensed under the MIT or GPLv3 licenses.
 * http://opensource.org/licenses/MIT
 * http://opensource.org/licenses/GPL-3.0
 *
 */

(function(){"use strict";var t,e,i,r,n,o,s,u,a,f,h,p,c=function(t,e){return function(){return t.apply(e,arguments)}};t=jQuery;f="presto";p="presto";u={1:{n:1,message:"The image couldn't be displayed."},2:{n:2,message:"The image couldn't be uploaded."},3:{n:3,message:"Image format not supported."}};s={revokeUrls:true,iframe:false,before:null,beforeEach:null,success:null,error:null,always:null,after:null};n=window.console||{log:function(){}};a=function(t){return t.prop("tagName")==="INPUT"&&t.attr("type")==="file"||!!n.log("Presto error: Not a file input.")};o=window.URL&&URL.createObjectURL.bind(URL)||window.webkitURL&&webkitURL.createObjectURL.bind(webkitURL)||window.createObjectURL;h=window.URL&&URL.revokeObjectURL.bind(URL)||window.webkitURL&&webkitURL.revokeObjectURL.bind(webkitURL)||window.revokeObjectURL;i=t.type(o)==="function";r=!!window.FileReader;e=function(){function e(e,i){this._doMagic=c(this._doMagic,this);var r,n,o,u;this.input=e=t(e);if(!a(e)){return}this.op=t.extend(true,{},s,i,e.data(f));u=["before","beforeEach","success","error","always","after"];for(n=0,o=u.length;n<o;n++){r=u[n];if(t.type(this.op[r])!=="function"){this.op[r]=null}}if(!(this.op.iframe&&this.op.iframe.url)){this.op.iframe=false}if(this.op.iframe){t.extend(this.op.iframe,{dataType:"iframe json",fileInputs:this.input})}this._castImgSpell=this._chooseSpell();if(!this._castImgSpell){return}this.enabled=true;this.input.on("change."+p,this._doMagic)}e.prototype._chooseSpell=function(){if(i){return this._createURL}else if(r){return this._readFile}else if(this.op.iframe){return this._iframeTransport}else{return n.log("Presto error: No method to display images.")||null}};e.prototype._doMagic=function(){var t;if(!this.enabled){return}if(this.op.before&&this.op.before(this.input)===false){return}t=this.input.val()?1:0;t=this.input[0].files!=null?this.input[0].files.length:void 0;if(t===0){return}this.total=t;this.count=0;return this._castImgSpell()};e.prototype._summonImg=function(e,r){var n;n=t("<img>");n.on("load",function(t){return function(){if(i&&t.op.revokeURL){h(e)}return t._success(n,r)}}(this));n.on("error",function(t){return function(){if(i&&t.op.revokeURL){h(e)}return t._error(3)}}(this));return n.attr("src",e)};e.prototype._success=function(t,e){this.count++;if(this.op.success){this.op.success(t,e,this.input)}if(this.op.always){this.op.always(this.input)}if(this.count===this.total&&this.op.after){return this.op.after(this.input)}};e.prototype._error=function(t){this.count++;if(this.op.error){this.op.error(u[t],this.input)}if(this.op.always){this.op.always(this.input)}if(this.count===this.total&&this.op.after){return this.op.after(this.input)}};e.prototype._createURL=function(){var t,e,i,r,n;r=this.input[0].files;n=[];for(e=0,i=r.length;e<i;e++){t=r[e];if(this.op.beforeEach&&this.op.beforeEach(t,this.input)===false){continue}n.push(this._summonImg(o(t),t))}return n};e.prototype._readFile=function(){var t,e,i,r,n;r=this.input[0].files;n=[];for(e=0,i=r.length;e<i;e++){t=r[e];if(this.op.beforeEach&&this.op.beforeEach(t,this.input)===false){continue}n.push(this._read(t))}return n};e.prototype._read=function(t){var e;e=new FileReader;e.onload=function(i){return function(){return i._summonImg(e.result,t)}}(this);e.onerror=function(t){return function(){return t._error(1)}}(this);return e.readAsDataURL(t)};e.prototype._iframeTransport=function(){var e;if(this.op.beforeEach&&this.op.beforeEach(this.input.val(),this.input)===false){return}e=t.ajax(this.op.iframe);e.done(function(t){return function(e){return t._summonImg(e.src,e)}}(this));return e.fail(function(t){return function(){return t._error(2)}}(this))};e.prototype.enable=function(){return this.enabled=true};e.prototype.disable=function(){return this.enabled=false};e.prototype.remove=function(){this.input.off("change."+p,this._doMagic);return this.input.removeData(f+"Instance")};return e}();t.fn[f]=function(i){if(typeof i!=="string"){return this.each(function(){var r;if(!t.data(this,f+"Instance")){r=new e(this,i);return t.data(this,f+"Instance",r)}})}else if(i==="enable"||i==="disable"||i==="remove"){return this.each(function(){var e;e=t.data(this,f+"Instance");if(e!=null){return e[i]()}})}}}).call(this);
